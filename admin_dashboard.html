<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Bank of Maharashtra · Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Firebase SDK (compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Roboto, system-ui, -apple-system, sans-serif; }
        body { background: #f0f4f8; min-height: 100vh; padding: 20px; }
        .dashboard-container { max-width: 1400px; margin: 0 auto; }
        .header { background: #003366; color: white; padding: 20px 30px; border-radius: 30px 30px 0 0; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; border-bottom: 4px solid #f9b81b; }
        .header h1 { display: flex; align-items: center; gap: 10px; }
        .user-info { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .whatsapp-btn { background: #25D366; color: white; padding: 10px 20px; border-radius: 50px; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
        .whatsapp-btn:hover { background: #128C7E; }
        .logout-btn { background: #dc3545; color: white; padding: 10px 20px; border-radius: 50px; border: none; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
        .logout-btn:hover { background: #c82333; }
        .filter-bar { background: white; padding: 15px 30px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap; border-bottom: 2px solid #f9b81b; }
        .filter-bar label { font-weight: 600; color: #003366; }
        .filter-bar select { padding: 8px 16px; border-radius: 30px; border: 1px solid #b3c7de; background: #f9fcff; min-width: 200px; }
        .content { background: white; padding: 30px; border-radius: 0 0 30px 30px; box-shadow: 0 10px 30px rgba(0,40,80,0.1); }
        .submissions { display: flex; flex-direction: column; gap: 30px; }
        .submission-card { background: #f9fcff; border-radius: 24px; padding: 20px; border: 1px solid #d4e2f0; box-shadow: 0 4px 12px rgba(0,0,0,0.05); position: relative; }
        .card-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #f9b81b; padding-bottom: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .card-header h3 { color: #003366; font-weight: 600; }
        .timestamp { color: #5f6f82; font-size: 0.9rem; }
        .badge-pending { background: #ffc107; color: #003366; padding: 4px 12px; border-radius: 30px; font-size: 0.8rem; font-weight: 600; margin-left: 10px; }
        .details-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .detail-item { background: white; border-radius: 16px; padding: 12px 16px; border: 1px solid #e2ecf9; }
        .detail-item strong { color: #003366; display: block; margin-bottom: 5px; font-size: 0.9rem; }
        .file-preview { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .file-preview img { max-width: 100px; max-height: 100px; border-radius: 8px; border: 1px solid #ccc; cursor: pointer; }
        .file-link { display: inline-block; padding: 6px 12px; background: #e9f0f9; border-radius: 30px; color: #003366; text-decoration: none; font-size: 0.9rem; }
        .action-buttons { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; justify-content: flex-end; }
        .btn-action { padding: 8px 16px; border: none; border-radius: 30px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; transition: 0.2s; }
        .btn-preview { background: #17a2b8; color: white; }
        .btn-preview:hover { background: #138496; }
        .btn-edit { background: #f9b81b; color: #003366; }
        .btn-edit:hover { background: #e0a617; }
        .btn-whatsapp { background: #25D366; color: white; text-decoration: none; }
        .btn-whatsapp:hover { background: #128C7E; }
        .btn-approve { background: #28a745; color: white; }
        .btn-approve:hover { background: #218838; }
        .btn-reject { background: #dc3545; color: white; }
        .btn-reject:hover { background: #c82333; }
        .btn-delete { background: #6c757d; color: white; }
        .btn-delete:hover { background: #5a6268; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; border-radius: 28px; padding: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        .modal-content h3 { color: #003366; margin-bottom: 20px; }
        .modal-detail-row { margin-bottom: 15px; border-bottom: 1px solid #e2ecf9; padding-bottom: 10px; }
        .modal-detail-row strong { color: #003366; display: block; margin-bottom: 5px; }
        .modal-file-preview { display: flex; gap: 10px; flex-wrap: wrap; }
        .modal-file-preview a { background: #e9f0f9; padding: 6px 12px; border-radius: 30px; text-decoration: none; color: #003366; }
        .close-modal { background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 30px; cursor: pointer; margin-top: 20px; }
    </style>
</head>
<body>
<div class="dashboard-container">
    <div class="header">
        <h1><i class="fas fa-shield-alt"></i> Bank of Maharashtra · Admin Dashboard</h1>
        <div class="user-info">
            <span><i class="fas fa-user"></i> <span id="currentUser"></span></span>
            <a href="https://wa.me/" target="_blank" class="whatsapp-btn" id="globalWhatsApp">
                <i class="fab fa-whatsapp"></i> Bank WhatsApp
            </a>
            <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>
    </div>

    <div class="filter-bar">
        <label><i class="fas fa-filter"></i> Filter by District:</label>
        <select id="districtFilter">
            <option value="">All Districts</option>
        </select>
    </div>

    <div class="content">
        <h2 style="margin-bottom: 20px; color: #003366;"><i class="fas fa-file-alt"></i> All Submissions</h2>
        <div id="submissionsList" class="submissions"></div>
    </div>
</div>

<!-- Preview Modal -->
<div id="previewModal" class="modal">
    <div class="modal-content" id="modalContent">
        <!-- dynamic content -->
    </div>
</div>

<script>
    if (sessionStorage.getItem('bom_admin_logged_in') !== 'true') {
        window.location.href = 'admin_login.html';
    }
    const currentUsername = sessionStorage.getItem('bom_admin_user');
    document.getElementById('currentUser').innerText = currentUsername;

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyCj3LrqCtkY6k_4Mxn-6TIee-rvF9JHFLI",
        authDomain: "teammotaleb-system.firebaseapp.com",
        projectId: "teammotaleb-system",
        storageBucket: "teammotaleb-system.firebasestorage.app",
        messagingSenderId: "673804801831",
        appId: "1:673804801831:web:6478ce66301984f931fb02",
        measurementId: "G-4L9V64SVBV"
    };

    let db;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        console.log('Firebase initialized successfully');
    } catch (error) {
        console.error('Firebase initialization error:', error);
        alert('Failed to initialize Firebase. Please check your configuration.');
    }
    const submissionsCollection = db.collection('submissions');

    const USERS_KEY = 'bom_admin_users'; // still localStorage for admin users

    function renderSubmissions(filtered) {
        const container = document.getElementById('submissionsList');
        container.innerHTML = '';
        if (filtered.length === 0) {
            container.innerHTML = '<div class="no-data" style="text-align:center; padding:50px; color:#a4bbd5;"><i class="fas fa-folder-open fa-3x"></i><p>No submissions found.</p></div>';
            return;
        }
        filtered.reverse().forEach((sub) => {
            const card = document.createElement('div');
            card.className = 'submission-card';
            const pendingBadge = sub.pendingData ? '<span class="badge-pending"><i class="fas fa-clock"></i> Pending Approval</span>' : '';

            const header = document.createElement('div');
            header.className = 'card-header';
            header.innerHTML = `
                <h3><i class="fas fa-file-alt"></i> ${sub.agentName || 'N/A'} (PAN: ${sub.pan || 'N/A'}) ${pendingBadge}</h3>
                <span class="timestamp"><i class="far fa-clock"></i> ${new Date(sub.timestamp).toLocaleString()}</span>
            `;
            card.appendChild(header);

            const districtInfo = document.createElement('div');
            districtInfo.style.marginBottom = '10px';
            districtInfo.innerHTML = `<strong>District:</strong> ${sub.shopDistrict || 'N/A'}`;
            card.appendChild(districtInfo);

            const actions = document.createElement('div');
            actions.className = 'action-buttons';

            // Preview button
            const previewBtn = document.createElement('button');
            previewBtn.className = 'btn-action btn-preview';
            previewBtn.innerHTML = '<i class="fas fa-eye"></i> Preview';
            previewBtn.onclick = () => {
                const url = `index.html?pan=${encodeURIComponent(sub.pan)}&dob=${encodeURIComponent(sub.dob)}`;
                window.open(url, '_blank');
            };
            actions.appendChild(previewBtn);

            // Grant Edit button
            const grantBtn = document.createElement('button');
            grantBtn.className = 'btn-action btn-edit';
            grantBtn.innerHTML = sub.editPermission ? '<i class="fas fa-times"></i> Revoke Edit' : '<i class="fas fa-check"></i> Grant Edit';
            grantBtn.onclick = () => toggleEditPermission(sub.id, sub.editPermission);
            actions.appendChild(grantBtn);

            // WhatsApp button
            if (sub.whatsapp) {
                const waBtn = document.createElement('a');
                waBtn.href = `https://wa.me/${sub.whatsapp.replace(/[^0-9]/g, '')}`;
                waBtn.target = '_blank';
                waBtn.className = 'btn-action btn-whatsapp';
                waBtn.innerHTML = '<i class="fab fa-whatsapp"></i> WhatsApp';
                actions.appendChild(waBtn);
            }

            // Delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn-action btn-delete';
            deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Delete';
            deleteBtn.onclick = () => deleteSubmission(sub.id);
            actions.appendChild(deleteBtn);

            // If pending data, add Approve/Reject
            if (sub.pendingData) {
                const approveBtn = document.createElement('button');
                approveBtn.className = 'btn-action btn-approve';
                approveBtn.innerHTML = '<i class="fas fa-check-circle"></i> Approve';
                approveBtn.onclick = () => approveChanges(sub.id, true, sub.pendingData);
                actions.appendChild(approveBtn);

                const rejectBtn = document.createElement('button');
                rejectBtn.className = 'btn-action btn-reject';
                rejectBtn.innerHTML = '<i class="fas fa-times-circle"></i> Reject';
                rejectBtn.onclick = () => approveChanges(sub.id, false);
                actions.appendChild(rejectBtn);
            }

            card.appendChild(actions);
            container.appendChild(card);
        });
    }

    // Toggle edit permission
    async function toggleEditPermission(docId, currentPermission) {
        try {
            await submissionsCollection.doc(docId).update({
                editPermission: !currentPermission,
                editRequest: false
            });
        } catch (error) {
            console.error('Error toggling edit permission:', error);
            alert('Error updating permission. Please try again.');
        }
    }

    // Approve or reject pending changes
    async function approveChanges(docId, approve, pendingData = null) {
        try {
            if (approve && pendingData) {
                pendingData.editPermission = false;
                await submissionsCollection.doc(docId).set({
                    ...pendingData,
                    pendingData: null
                });
            } else {
                await submissionsCollection.doc(docId).update({
                    pendingData: null
                });
            }
        } catch (error) {
            console.error('Error approving/rejecting changes:', error);
            alert('Error updating submission. Please try again.');
        }
    }

    // Delete submission
    async function deleteSubmission(docId) {
        if (!confirm('Are you sure you want to delete this application? This action cannot be undone.')) return;
        try {
            await submissionsCollection.doc(docId).delete();
        } catch (error) {
            console.error('Error deleting submission:', error);
            alert('Error deleting submission. Please try again.');
        }
    }

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
        sessionStorage.removeItem('bom_admin_logged_in');
        sessionStorage.removeItem('bom_admin_user');
        window.location.href = 'admin_login.html';
    });

    // Initialize: start listener and populate district filter
    let unsubscribe;
    unsubscribe = submissionsCollection.onSnapshot((snapshot) => {
        const submissions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        const filterDistrict = document.getElementById('districtFilter').value;
        const filtered = filterDistrict ? submissions.filter(s => s.shopDistrict === filterDistrict) : submissions;
        renderSubmissions(filtered);

        // Update district dropdown options
        const districts = [...new Set(submissions.map(s => s.shopDistrict).filter(d => d))];
        const select = document.getElementById('districtFilter');
        const currentVal = select.value;
        select.innerHTML = '<option value="">All Districts</option>';
        districts.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d;
            opt.textContent = d;
            if (d === currentVal) opt.selected = true;
            select.appendChild(opt);
        });
    }, (error) => {
        console.error('Error in snapshot listener:', error);
        alert('Error loading submissions. Please refresh the page.');
    });

    // When filter changes, the snapshot already provides all data; we just re-render
    document.getElementById('districtFilter').addEventListener('change', () => {
        // Unsubscribe and re-subscribe to force re-evaluation? Actually the listener already gives all docs,
        // but we need to re-filter. We'll just call the render function with current data.
        // However we don't have the latest submissions array here. We'll rely on the snapshot listener's next call.
        // To avoid delay, we can re-filter immediately using the last data.
        // But we don't have the last data stored. We'll just let the snapshot update in its own time.
        // For immediate feedback, we could store the last submissions array.
        // We'll implement a simple cache:
        if (window.lastSubmissions) {
            const filter = document.getElementById('districtFilter').value;
            const filtered = filter ? window.lastSubmissions.filter(s => s.shopDistrict === filter) : window.lastSubmissions;
            renderSubmissions(filtered);
        }
    });

    // Store last submissions for filter changes
    window.lastSubmissions = [];
    submissionsCollection.onSnapshot((snapshot) => {
        window.lastSubmissions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        const filterDistrict = document.getElementById('districtFilter').value;
        const filtered = filterDistrict ? window.lastSubmissions.filter(s => s.shopDistrict === filterDistrict) : window.lastSubmissions;
        renderSubmissions(filtered);

        const districts = [...new Set(window.lastSubmissions.map(s => s.shopDistrict).filter(d => d))];
        const select = document.getElementById('districtFilter');
        const currentVal = select.value;
        select.innerHTML = '<option value="">All Districts</option>';
        districts.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d;
            opt.textContent = d;
            if (d === currentVal) opt.selected = true;
            select.appendChild(opt);
        });
    });
</script>
</body>
</html>